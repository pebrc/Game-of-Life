<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Game of Life</title>
		<link rel="stylesheet" href="gol.css" type="text/css" >
		<script src="raphael.js" type="text/javascript" charset="utf-8"></script>
		<script src="jquery-1.7.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">
			Array.matrix = function(m, n, initial) { 
				var i, j, t,  mat = [];
				for(i = 0; i < m; i++) {
					t = [];
					for(j = 0; j< n; j++) {
						t[j] = initial;
					}
					mat[i] = t;
				}
				return mat;
			};
			var rangeattr = {stroke: "#f00", fill: "none", "arrow-end":"classic-wide-long"};
			var pointattr = {fill: "#fff", stroke: "none"};
			var gridattr = {stroke: "#fff"};
			var lifeattr = {fill: "#5ecc32"};
			var deathattr = {fill: "none"};
			var config = {cells: 20, size: 20, origin: {x:5,y:5},speed: 400, setup: [[1,2],[2,3],[2,2],[3,4],[3,2]]};
			//var config = {cells: 20, size: 20, origin: {x:5,y:5},speed: 500, setup: [[5,10],[6,10],[7,10],[8,10],[9,10],[10,10],[11,10],[12,10]]};
			//var config = {cells: 40, size: 20, origin: {x:5,y:5},speed: 500, setup: [[5,10],[6,10],[7,10],[8,10],[9,10],[10,10],[11,10],[12,10],[13,10],[14,10],[15,10],[16,10],[17,10],[18,10],[19,10],[0,11],[1,11],[1,12],[1,13],[1,14],[1,15],[1,16],[1,17]]};
			var game = {
				running : false,
				runner : {},
				config: {},
				paper:  {},
				init : function(cnf) {
					this.paper  = Raphael("holder", 1000, 900);
					this.setConfig(cnf);
					this.createGrid();
					this.setup(cnf);
					this.evenHandling();
					this.start();
				},
				evenHandling : function() {
					var that = this;

					$(holder).click(function(e){
							that.running ? that.stop() : that.start();
							console.log('stop');
							}) ;
					this.grid.frame.hover(function(){
							that.stop();
							//console.log('hoverin');
							}, function(){
							that.start();
							});
					this.grid.elems.mouseover(function(e){
							if(!that.running) {
							   console.log(e);
							}
							});
	       			},
				grid: {
					    frame:{},
				            elems:{},
					    gui:{},
					    currentGen:{},
					    nextGen:{}
				      },
				setConfig : function (conf) {
						    this.config = conf
						    this.grid.gui = Array.matrix(this.config.cells, this.config.cells,null);
						    this.grid.currentGen = Array.matrix(this.config.cells, this.config.cells, false);
						    this.grid.nextGen = Array.matrix(this.config.cells, this.config.cells, false);

	    			},
				createGrid : function() {
						     var x = this.config.origin.x;
						     var y = this.config.origin.y;
						     var maxx = this.config.cells * this.config.size + x;
						     var maxy = maxx - x + y;
						     this.grid.frame = this.paper.rect(x,y,maxx - x, maxy -y).attr(gridattr);
						     this.paper.setStart();
						     for(var i  = 0;i < this.config.cells; i++) {
							     for(var j = 0; j < this.config.cells; j++) {
								     var el = this.paper.rect(x,y,this.config.size, this.config.size).attr(gridattr);
									this.grid.gui[i][j] = el;
									x+= this.config.size;
							     }
							x = this.config.origin.x;     
							y+= this.config.size;
						     }
						     this.grid.elems = this.paper.setFinish();
						     this.grid.frame.toFront().attr({fill: "#cc6232",opacity:0});
						     
				},
				setup : function(cnf) {
						var i, el;
						for(i = 0; i < cnf.setup.length; i++ ) {
							el = cnf.setup[i];
							this.live(this.grid.currentGen,el[0], el[1]);
						}

					},
				live : function(gen, x, y) {
					       gen[x][y] = true;
					       this.grid.gui[x][y].attr(lifeattr);
				       },
				die : function(gen,x,y) {
					       gen[x][y] = false;
					       this.grid.gui[x][y].attr(deathattr);
				      },
				start : function() {
						this.running = true;
						var game = this;
						var helper = function() {
							game.tick();
						};
						this.runner = setInterval(helper, this.config.speed);
					},
				stop : function() {
					       this.running = false;
					       clearInterval(this.runner);

				       },
				tick : function() {
				//	console.log('tick');
					var i, j, a;
					for(i=0;i<this.grid.gui.length;i++) {
						for(j=0;j < this.grid.gui[i].length;j++) {
							if(this.willLive(this.grid.currentGen,i,j)) {
								this.live(this.grid.nextGen, i,j);
							} else {
								this.die(this.grid.nextGen, i, j);
							}
						}
					}
					a = this.grid.currentGen;
					this.grid.currentGen = this.grid.nextGen;
					this.grid.nextGen = a;
				       },
				willLive: function(grid, x, y)  {
					var alive,xl, yl, dx, dy,mx, my,perm,i,lifearound = 0;
					alive = grid[x][y];
					xl = grid.length -1 ;
					yl = grid[x].length -1;
					dx = (x + 1) % xl;
					dy = (y + 1) % yl;
					mx = x == 0 ? xl -1 : x -1;
					my = y == 0 ? yl - 1 : y -1;
					perm = [[dx,y],[x,dy],[mx,y],[x,my],[dx,dy],[mx,my],[dx,my],[mx,dy]];
					i = 0;
					while(i < perm.length ) {
						
						if(grid[perm[i][0]][perm[i][1]]) {
							lifearound++;
						}
						i++;
					}
					//console.log(x + ", "+ y + ": " +lifearound);
					return (alive && lifearound == 2) || (lifearound === 3);

					
				}
				

			};

			$(document).ready( function () {
				game.init(config);
			});
		</script>

	</head>
	<body>
		<div id="holder"> </div>
	</body>
</html>
